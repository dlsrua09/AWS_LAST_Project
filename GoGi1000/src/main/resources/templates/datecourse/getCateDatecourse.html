<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http:///www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">

<!-- head 영역 시작 -->
<!-- 개별적으로 사용할 css, js 링크 걸기 위해서 남겨둠 -->
<head>
  <th:block layout:fragment="css">
  	  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
      <link rel="stylesheet" th:href="@{/css/getCateDatecourse.css}"/>
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/bxslider/4.2.12/jquery.bxslider.css">
  </th:block>
  
  <th:block layout:fragment="script">
  	  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=47a1b106ab3eb419877b9f10cf48ce66&libraries=services"></script>
  	  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous">
  	  	const myModal = document.getElementById('myModal')
		const myInput = document.getElementById('myInput')
		
		  myModal.addEventListener('shown.bs.modal', () => {
		  myInput.focus()
		})
  	  </script>
	  <script th:inline="javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	  <script th:inline="javascript" src="https://code.jquery.com/jquery-3.6.1.js"></script>
	  <script th:inline="javascript" src="https://cdn.jsdelivr.net/bxslider/4.2.12/jquery.bxslider.min.js"></script>
	    <script th:inline="javascript">
			
		      /* 이미지 슬라이드 */
		      $(document).ready(function() {
			      $("#menu-img").bxSlider({
					touchEnabled : (navigator.maxTouchPoints > 0), // 이미지를 터치 가능하게 해줌.
			        slideWidth: 150,        // 이미지의 너비
			        maxSlides : 3,          // 이미지의 최대 노출 개수
			        minSlides : 2,          // 이미지의 최소 노출 개수
			        moveSlides : 1,         // 이미지의 이동 개수
			        slideMargin: 20,        // 이미지 사이의 마진
			        pager:false,            // 블릿의 유무, 기본값: true
			        infiniteLoop:false,     // 슬라이더 무한루프 여부
			        hideControlOnEnd: true, // 슬라이더 첫번재 마지막 버튼 감추기
			        controls:  true,        // 화살표 버튼 유무, 기본값: false
			      })     
		      })
		    
		    $(function(){
				const loginUserId = /*[[${#authentication.principal}]]*/;
				console.log(loginUserId);

	        	$("#datecourseAdd").on("click", function(e) {
					if(loginUserId == 'anonymousUser') {
						e.preventDefault();
						alert("로그인 후에 이용하실 수  있습니다.")
						window.location.href="/user/login"
					}
	          		if($("#datecourseAdd-text").text() == "데이트 코스에 추가") { 
						  console.log("hi")
	            		const MyDateIns = {
						  datecourseNo: $("#datecourseAdd").attr('datecourse-no')
					  	}
					  	console.log(MyDateIns)
					  	
	            		$.ajax({
							// get방식: 서버에서 데이터를 요청할때, post방식: 서버의 리소스를 생성하거나, 업데이트할 때 사용
							url: '/datecourse/insertMyDatecourse',
							type: 'post',
							data: {MyDateIns : JSON.stringify(MyDateIns)},
							success: function(obj) {
								alert("내 데이트코스에 추가 하였습니다.");
								$("#datecourseAdd-text").text("데이트 코스에서 제외")
							},
							error: function(e) {
								console.log(e);
							}
						});
						
	            		
	          		}
	          		
		          	else if($("#datecourseAdd-text").text() == "데이트 코스에서 제외"){
						  console.log($("#datecourseAdd").attr('datecourse-no'))
		            	const MyDateDel = {
						  datecourseNo: $("#datecourseAdd").attr('datecourse-no')
					  	}
					  	$.ajax({
							url: '/datecourse/deleteMyDatecourse',
							type: 'delete',
							data: {MyDateDel : JSON.stringify(MyDateDel)},
							success: function(obj) {
								alert("내 데이트코스에서 제외되었습니다.");
							},
							error: function(e) {
								console.log(e);
							}
						});
						$("#datecourseAdd-text").text("데이트 코스에 추가")  
		          	}
		          	
	      		})
	      		
	      		// 사이트(하이퍼링크) 언더바 제거_인겸
		      	$("#datecourseOfficialSiteA").css("text-decoration","none");
	      		
	      		// 주차가능 유무_인겸
	      		if ($("#datecourseParkingYn").text() == 'Y') {
					  $("#datecourseParkingYn").text("가능")
				  } else {
					  $("#datecourseParkingYn").text("불가능");
				  }
				
				$(".datecourseMenuPrice").each(function() {
					var datecourseMenuPrice = $(this).text();
	      			var datecourseMenuPrice2 = datecourseMenuPrice.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
	      			$(this).text(datecourseMenuPrice2);
				})
				
				  
			      
				// 이미지 클릭 시 모달 우선순위 맨앞으로_인겸
				$(".getModalImageList").on("click", function() {
					$(".modal").css("z-index", 9999);
					
				})
				
				function showModal(e) {
					
				}
		      		
	      	})
	      	$(function () {
                    /*global kakao*/
                    var container = document.getElementById("datecourse-map-container");
                    var options = {
                        center: new kakao.maps.LatLng(33.450701, 126.570667),
                        level: 3
                    }

                    var map = new kakao.maps.Map(container, options);
                    var geocoder = new kakao.maps.services.Geocoder();

                    geocoder.addressSearch($("#datecourseAddr").text(), function (result, status) {
                        if (status != kakao.maps.services.Status.OK) {
                            return alert('Something wrong!');
                        }
                        if (status === kakao.maps.services.Status.OK) {
                            var coords = new kakao.maps.LatLng(
                                result[0].y, result[0].x);
				
                            var marker = new kakao.maps.Marker({
                                map: map,
                                position: coords
                            })
                            
                            console.log(result)
                            console.log(status)
                            var content = '<div style="min-width: 100px; height:40px; line-height:40px; text-align:center;"><b>' + $("#datecourseNm").text() + '</b></div>'

                            var infowindow = new kakao.maps.InfoWindow({
                                content: content,
                                removable: true

                            })
                            map.setCenter(coords)

							infowindow.open(map, marker);

                            kakao.maps.event.addListener(marker, "click", function() {
								map.setCenter(marker.getPosition())
							})
							/* 마커 마우스 오버 이벤트 -> 마커 위에 마우스를 올리면 infoWindow open*/
							kakao.maps.event.addListener(marker, "mouseover", function() {
        						map.setCenter(marker.getPosition())
							})                            
                        }

                    })
                    
                    // 댓글 입력 500자 제한_장찬영
                    $("#comment-text").on("keyup", function() {
				        if($("#comment-text").val().length > 500) {
				          	$("#comment-text").val($("#comment-text").val().substring(0, 500));
				          	alert("글자수는 500자까지 입력 가능합니다.");
				        }
				    });
					
					// 댓글 등록 및 출력_장찬영
					$("#comment-button").on("click", function() {
						const requestComment = {
							datecourseNo: $("#comment-button").attr('datecourse-no'),
							reviewComment: $("#comment-text").val()						
						}					
						console.log(requestComment);
						
						$.ajax({
								url: '/review/insertReview',
								type: 'post',
								data: {requestComment : JSON.stringify(requestComment)},
								success: function(obj) {
									console.log(obj)
									let htmlStr = "";					
									htmlStr = `
										<div class="comment-container">
									      <div class="comment-left-section">
									        <div>
									          <img src="/images/user.png">
									        </div>
									      </div>
									      <div class="comment-right-section">
									        <div class="comment-right-top">
									          <div class="comment-user">
									            <a>${obj.item.review.reviewerId}</a>
									          </div>
									          <div class="comment-regdate">
									            <a>${obj.item.review.reviewModfDate.split('T')[0]}</a>
									          </div>
									          <div class="comment-update">
								            	<a datecourse-no="${obj.item.review.datecourseNo}" review-no="${obj.item.review.reviewNo}">수정</a>
								              </div>&ensp;
								              <div class="comment-delete">
								            	<a datecourse-no="${obj.item.review.datecourseNo}" review-no="${obj.item.review.reviewNo}">삭제</a>
								              </div>
									        </div>
									        <div class="comment-right-bottom">
									          <div class="comment-comment">
									            <p>${obj.item.review.reviewComment}</p>
									          </div>
									        </div>
									      </div>
									    </div>
									`;
									
									$("#datecourse-comment-container").children().eq(1).append(htmlStr);
									
								},
								error: function(e) {
									console.log(e);
								}
							});
					});
					
					// 댓글 삭제_장찬영
					$(".comment-delete-click").on("click", function() {
						const result = {
							datecourseNo: $(this).attr('datecourse-no'),
							reviewNo: $(this).attr('review-no')
						}						
						const datecourseNo = $(this).attr('datecourse-no')
						
						console.log(result);
						
						$.ajax({
								url: '/review/deleteReview',
								type: 'delete',
								data: {result : JSON.stringify(result)},
								success: function(obj) {
									window.location.href="/main/getCateDatecourse/" + datecourseNo
								},
								error: function(e) {
									console.log(e);
								}
						});
					});
					
					// 댓글 수정_장찬영
					$(".comment-update-click").on("click", function() {
						const updateReview = {
							datecourseNo: $(this).attr('datecourse-no'),
							reviewNo: $(this).attr('review-no'),
							reviewComment: $(this).parent("div").parent("div").parent("div").children("div:last-child").children("div").children("p").text()
						}						
						console.log(updateReview);
						
						$.ajax({
							url: '/review/updateReview',
							type: 'put',
							data: {updateReview : JSON.stringify(updateReview)},
							success: function(obj) {
									
								},
								error: function(e) {
									console.log(e);
								}
						})
						
					});
                });
		</script>
  </th:block>  
  
    
</head>
<body>
	<div layout:fragment="content">
	  <div id="datecourse-detail-container">
	    <h1 th:text="${datecourse.datecourseNm}" id="datecourseNm"></h1>
	  </div>
	
	  <!-- 메인 이미지 영역 -->
	  <div id="datecourse-img-container">
	    <div id="main-img">
	      <div th:each="datecourseImageDTOList : ${datecourseImageDTOList}">
	        <a th:href="@{${datecourse.datecourseOfficialSite}}"><img th:if="${datecourseImageDTOListStat.index == 0}"
	        				 th:src="@{'/upload/' + ${datecourseImageDTOList.imageNm}}"
	        			     width="600" height="400" >
	        </a>
	      </div>
	    </div>
	  </div>
	
	  <!-- 데이트코스 설명 부분 -->
	  <div id="datecourse-main-info">
	    <div id="main-info">
	      <h2 th:text="${datecourse.datecourseDesc}"></h2><br>
	    </div>
	  </div>
	
	  <!-- 구분선 -->
	  <hr class="hrLine">
	
	  <!-- 데이트코스 서브 정보 -->
	  <div id="datecourse-sub-info">
	    <div class="datecourse-line">
	      <div class="sub-img">
	        <img th:src="@{/images/address.png}" width="30" height="30">
	      </div>
	      <div class="sub-title">
	        <h5>주소</h5>
	      </div>
	      <div class="sub-info" >
	        <h5 th:text="${datecourse.datecourseAddr}" id="datecourseAddr"></h5>
	      </div>
	      <button type="button" class="btn1" id="datecourseAdd" th:datecourse-no="${datecourse.datecourseNo}">
	        <span class="btn_inner" id="datecourseAdd-text">데이트 코스에 추가</span>
	      </button>
	    </div>
	    <div class="datecourse-line">
	      <div class="sub-img">
	        <img th:src="@{/images/tel.png}" width="30" height="30">
	      </div>
	      <div class="sub-title">
	        <h5>전화번호</h5>
	      </div>
	      <div class="sub-info" id="InfoTel">
	        <h5 th:text="${datecourse.datecourseTel}"></h5>
	      </div>
	      <!-- 데이트코스 검색 -->
	      <div id="searchDatecourse">
	        <div>
	          <button type="button" id="searchNaver">
	            <span>검색</span>
	          </button>
	        </div>
	        <div id="searchInputWrapper" >
	        	<form action="" method="get" id="cateDatecourseForm" name="cateDatecourseSearchInput">
	              <input id="cateDatecourseSearchInput" name="cateDatecourseSearchInput"
	              		 placeholder="음식점 또는 지역을 입력해주세요" onfocus="this.placeholder=''" 
						 onblur="placeholder='음식점 또는 지역을 입력해주세요'">
				</form>
	          <img th:src="@{/images/expand.PNG}" style="margin-left: 6px;">
	        </div>
	        <div id="searchImg">
	          <img th:src="@{/images/search.png}" width="27" height="27">
	        </div>
	      </div>
	
	    </div> 
	    <div class="datecourse-line">
	      <div class="sub-img">
	        <img th:src="@{/images/site.png}" width="30" height="30">
	      </div>
	      <div class="sub-title">
	        <h5>웹 사이트</h5>
	      </div>
	      <div class="sub-info">
	        <a id="datecourseOfficialSiteA" th:href="@{${datecourse.datecourseOfficialSite}}"><h5 id="datecourseOfficialSite" th:text="${datecourse.datecourseOfficialSite}"></h5></a>
	      </div>
	    </div>   
	    <div class="datecourse-line">
	      <div class="sub-img">
	        <img th:src="@{/images/park.png}" width="30" height="30">
	      </div>
	      <div class="sub-title">
	        <h5>주차</h5>
	      </div>
	      <div class="sub-info">
	        <h5 id="datecourseParkingYn" th:text="${datecourse.datecourseParkingYn}" ></h5>
	      </div>
	    </div>   
	    <div class="datecourse-line">
	      <div class="sub-img">
	        <img th:src="@{/images/time.png}" width="30" height="30">
	      </div>
	      <div class="sub-title">
	        <h5>영업 정보</h5>
	      </div>
	      <div class="sub-info">
	         <div style="width:300px; display: flex;" th:each="datecourseHours : ${datecourseHours}">
	              <h5 th:text="${datecourseHours.datecourseHoursInfo}" style="margin-bottom:20px;"></h5><br>
	         </div>
	     </div>
	    </div>   
	    <div class="datecourse-line" style="display:inline-block;">
	      <div class="sub-img">
	        <img th:src="@{/images/menu.png}" width="30" height="30">
	      </div>
	      <div class="sub-title">
	        <h5>메뉴</h5>
	      </div>
	      <div class="sub-info"  >
	        <div style="display:flex; justify-content: left; align-items: center;" th:each="datecourseMenu : ${datecourseMenu}">
	        	<div style="width:500px; display: flex;">
			        <h5 style="width:200px; display: inline-block; margin:0 30px 20px 0" th:text="${datecourseMenu.datecourseMenuNm}"></h5> 
			        <h5 class="datecourseMenuPrice" th:text="${datecourseMenu.datecourseMenuPrice}"></h5>원
		        </div>
	        </div>
	      </div>
	    </div>
	    <!-- 메뉴 이미지 영역 -->
	    <div id="menu-img-container">
	      <div class="sub-img">
	        <img th:src="@{/images/image.png}" width="30" height="30">
	      </div>
	      <div class="sub-title">
	        <h5>이미지</h5>
	      </div>
	      <div id="menu-img" >
	        <div th:each="datecourseImageDTOList : ${datecourseImageDTOList}">
	             <a href="#" id="getModalImage"
	             			 class="getModalImageList" 
	                         th:datecourse-no="${datecourse.datecourseNo}" 
	                         data-bs-toggle="modal" 
	                         data-bs-target="#exampleModal"
	                         onclick="showModal()">
	             	<img th:src="@{'/upload/' + ${datecourseImageDTOList.imageNm}}"  
		                 th:if="${datecourseImageDTOListStat.index > 0}"
		          	     width="200" 
		          	     height="100">
	          	 </a>
	        </div>
	      </div>
	    </div>
	  </div>
	  <!-- 맵 영역 -->
	  <div id="datecourse-map-container">
	
	  </div>
	  <!-- 구분선 -->
	  <hr class="hrLine">
	
	  <!-- 댓글 영역 -->
	  <div id="datecourse-comment-container">
	  	<!-- 댓글 입력_장찬영 -->
	    <div id="comment-wrapper">
			<div id="comment-write">
				<textarea name="comment-text" id="comment-text" cols="80" rows="5" 
						placeholder="명예훼손, 개인정보 유출, 허위사실 유포 등의 글은 법률에 의해 처벌 받을 수 있습니다."></textarea>
				<button id="comment-button" th:datecourse-no="${datecourse.datecourseNo}">등록</button>      
			</div>
		</div>	  
	  
	  	<h4 style="margin-bottom: 20px;">댓글
	  		<span>(</span>
	  		<span style="color:#ee2d7a">??</span>
	  		<span>)</span>
	  	</h4>
	    <div class="comment-container" th:each="review : ${review}" th:if="${reviewStat.index < 5}"}>
	        <div class="comment-left-section">
	          <div>
	            <img th:src="@{/images/user.png}">
	          </div>
	        </div>
	        <div class="comment-right-section">
	          <div class="comment-right-top">
	            <div class="comment-user">
	              <a th:text="${review.reviewerId}"></a>
	            </div>
	            <div class="comment-regdate">
	              <a th:text="${#strings.substring(review.reviewModfDate, 0, 10)}"></a>
	            </div>
	            <div class="comment-update">
	            	<a class="comment-update-click" th:datecourse-no="${review.datecourseNo}" th:review-no="${review.reviewNo}">수정</a>
	            </div>&ensp;
	            <div class="comment-delete">
	            	<a class="comment-delete-click" th:datecourse-no="${review.datecourseNo}" th:review-no="${review.reviewNo}">삭제</a>
	            </div>
	          </div>
	          <div class="comment-right-bottom">
	            <div class="comment-comment">
	              <p th:text="${review.reviewComment}"></p>
	            </div>
	          </div>
	        </div>
	        <hr>
	      </div>
	    
	   
	    <div id="hide" style="display: none">
			
	  	  <div class="comment-container" th:each="review : ${review}" th:if="${reviewStat.index > 4}"}>
	        <div class="comment-left-section">
	          <div>
	            <img th:src="@{/images/user.png}">
	          </div>
	        </div>
	        <div class="comment-right-section">
	          <div class="comment-right-top">
	            <div class="comment-user">
	              <a th:text="${review.reviewerId}"></a>
	            </div>
	            <div class="comment-regdate">
	              <a th:text="${#strings.substring(review.reviewModfDate, 0, 10)}"></a>
	            </div>
	            <div class="comment-update">
	            	<a class="comment-update-click" th:datecourse-no="${review.datecourseNo}" th:review-no="${review.reviewNo}">수정</a>
	            </div>&ensp;
	            <div class="comment-delete">
	            	<a class="comment-delete-click" th:datecourse-no="${review.datecourseNo}" th:review-no="${review.reviewNo}">삭제</a>
	            </div>
	          </div>
	          <div class="comment-right-bottom">
	            <div class="comment-comment">
	              <p th:text="${review.reviewComment}"></p>
	            </div>
	          </div>
	        </div>
	        <hr>
	      </div>
	        
	     </div>	    
	    <div class="comment-hide">
	      <a href=#none id="show" onclick="if(hide.style.display=='none') {hide.style.display='';show.innerText='----- 댓글 접기 -----'} 
	      else {hide.style.display='none';show.innerText='----- 댓글 더보기 -----'}">----- 댓글 전체보기 -----</a>
	    </div>
	  </div>
	  
	  	<!-- Modal -->
		<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
		  <div class="modal-dialog modal-fullscreen-sm-down">
		    <div class="modal-content">
		      <div class="modal-body">
		        <div id="carouselExampleControls" class="carousel slide" data-bs-ride="carousel">
				  <div class="carousel-inner">
				    <div class="carousel-item active" th:each="datecourseImageDTOList : ${datecourseImageDTOList}">
				      <img th:src="@{'/upload/' + ${datecourseImageDTOList.imageNm}}" 
			               th:if="${datecourseImageDTOListStat.index > 0}"
			          	   class="d-block w-100 carouselImgList"
			          	   height="400px">
				    </div>
				  </div>
				  <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleControls" data-bs-slide="prev">
				    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
				    <span class="visually-hidden">Previous</span>
				  </button>
				  <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleControls" data-bs-slide="next">
				    <span class="carousel-control-next-icon" aria-hidden="true"></span>
				    <span class="visually-hidden">Next</span>
				  </button>
				</div>
		      </div>
		    </div>
		  </div>
		</div>
    </div>
</body> 
  
</html>